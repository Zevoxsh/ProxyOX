<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProxyOX Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; }
        h1 { color: #58a6ff; margin-bottom: 20px; font-size: 28px; }
        h2 { color: #79c0ff; margin: 30px 0 15px 0; font-size: 20px; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; background: #161b22; border: 1px solid #30363d; }
        th, td { border: 1px solid #30363d; padding: 12px; text-align: left; }
        th { background: #21262d; color: #58a6ff; font-weight: 600; }
        tr:hover { background: #1c2128; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #238636; border: 1px solid #2ea043; color: #fff; font-weight: 600; border-radius: 6px; transition: all 0.2s; }
        button:hover { background: #2ea043; }
        button.danger { background: #da3633; border-color: #f85149; }
        button.danger:hover { background: #f85149; }
        .status { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .status.running { background: #238636; color: #fff; }
        .status.stopped { background: #da3633; color: #fff; }
        pre { background: #161b22; padding: 15px; border: 1px solid #30363d; overflow-x: auto; border-radius: 6px; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .api-list { background: #161b22; padding: 20px; margin: 20px 0; border: 1px solid #30363d; border-radius: 6px; }
        .api-item { margin: 10px 0; padding: 15px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; }
        .api-item:hover { border-color: #58a6ff; }
        .method { display: inline-block; padding: 4px 10px; margin-right: 10px; font-weight: 700; border-radius: 4px; font-size: 11px; }
        .get { background: #1f6feb; color: #fff; }
        .post { background: #238636; color: #fff; }
        #error { color: #f85149; font-weight: bold; margin: 20px 0; padding: 15px; background: #161b22; border: 1px solid #f85149; border-radius: 6px; display: none; }
        #stats-container { margin: 20px 0; }
        .info-box { background: #161b22; padding: 15px; margin: 10px 0; border: 1px solid #30363d; border-radius: 6px; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        code { background: #161b22; padding: 2px 6px; border-radius: 3px; color: #79c0ff; }
    </style>
</head>
<body>
    <h1>üöÄ ProxyOX Dashboard</h1>
    
    <div id="error"></div>
    
    <h2>üìä Statistiques en temps r√©el</h2>
    <div id="stats-container">‚è≥ Chargement des statistiques...</div>
    
    <h2>üîß Actions rapides</h2>
    <div class="action-bar">
        <button onclick="validateConfig()">‚úÖ Valider Config</button>
        <button onclick="reloadConfig()">üìã Recharger Config</button>
        <button onclick="getSystemInfo()">üíª Info Syst√®me</button>
        <button onclick="toggleMaintenance()">‚ö†Ô∏è Mode Maintenance</button>
        <button onclick="exportJSON()">üì• Export JSON</button>
        <button onclick="exportCSV()">üì• Export CSV</button>
        <button class="danger" onclick="restartService()">üîÑ Red√©marrer</button>
    </div>
    
    <h2>üì° APIs disponibles</h2>
    <div class="api-list">
        <div class="api-item">
            <div>
                <span class="method get">GET</span>
                <code>/api/stats</code> - Statistiques en temps r√©el
            </div>
            <button onclick="testAPI('/api/stats', 'GET')">Tester</button>
        </div>
        <div class="api-item">
            <div>
                <span class="method get">GET</span>
                <code>/api/system/info</code> - Informations syst√®me (CPU, RAM, Disque)
            </div>
            <button onclick="testAPI('/api/system/info', 'GET')">Tester</button>
        </div>
        <div class="api-item">
            <div>
                <span class="method get">GET</span>
                <code>/api/config/validate</code> - Valider la configuration YAML
            </div>
            <button onclick="testAPI('/api/config/validate', 'GET')">Tester</button>
        </div>
        <div class="api-item">
            <div>
                <span class="method get">GET</span>
                <code>/api/history</code> - Historique des connexions
            </div>
            <button onclick="testAPI('/api/history', 'GET')">Tester</button>
        </div>
        <div class="api-item">
            <div>
                <span class="method post">POST</span>
                <code>/api/restart</code> - Red√©marrer le service ProxyOX
            </div>
            <button class="danger" onclick="testAPI('/api/restart', 'POST')">Tester</button>
        </div>
        <div class="api-item">
            <div>
                <span class="method post">POST</span>
                <code>/api/reload-config</code> - Recharger config.yaml sans red√©marrage
            </div>
            <button onclick="testAPI('/api/reload-config', 'POST')">Tester</button>
        </div>
        <div class="api-item">
            <div>
                <span class="method post">POST</span>
                <code>/api/maintenance</code> - Activer/d√©sactiver le mode maintenance
            </div>
            <button onclick="testAPI('/api/maintenance', 'POST', {enabled: true})">Tester</button>
        </div>
        <div class="api-item">
            <div>
                <span class="method post">POST</span>
                <code>/api/proxy/{name}/start</code> - D√©marrer un proxy sp√©cifique
            </div>
            <button onclick="startProxy()">Tester</button>
        </div>
        <div class="api-item">
            <div>
                <span class="method post">POST</span>
                <code>/api/proxy/{name}/stop</code> - Arr√™ter un proxy sp√©cifique
            </div>
            <button class="danger" onclick="stopProxy()">Tester</button>
        </div>
    </div>
    
    <h2>üìÑ R√©sultat derni√®re API</h2>
    <pre id="result">Cliquez sur "Tester" pour ex√©cuter une API</pre>

    <script>
        // R√©cup√©rer les credentials depuis l'authentification HTTP Basic du navigateur
        // Le navigateur les garde en m√©moire apr√®s le premier login
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method: method,
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(endpoint, options);
                
                // Si 401, le navigateur va automatiquement redemander le login
                if (response.status === 401) {
                    showError('‚ùå Erreur d\'authentification. Rechargez la page et reconnectez-vous.');
                    throw new Error('Non authentifi√©');
                }
                
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    return await response.json();
                } else {
                    return await response.text();
                }
            } catch (error) {
                showError('‚ùå Erreur: ' + error.message);
                throw error;
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        async function loadStats() {
            try {
                const stats = await apiCall('/api/stats');
                displayStats(stats);
            } catch (error) {
                console.error('Erreur chargement stats:', error);
                document.getElementById('stats-container').innerHTML = 
                    '<div class="info-box">‚ùå Impossible de charger les statistiques. V√©rifiez votre connexion.</div>';
            }
        }
        
        function displayStats(stats) {
            let html = '<table><thead><tr>';
            html += '<th>Nom</th><th>Protocole</th><th>Listen</th><th>Target</th><th>Statut</th>';
            html += '<th>Requ√™tes</th><th>Envoy√©s</th><th>Re√ßus</th><th>Uptime</th>';
            html += '</tr></thead><tbody>';
            
            if (stats.proxies && stats.proxies.length > 0) {
                stats.proxies.forEach(proxy => {
                    const st = proxy.stats || {};
                    html += `<tr>
                        <td><strong>${proxy.name}</strong></td>
                        <td>${proxy.protocol.toUpperCase()}</td>
                        <td>${proxy.listen}</td>
                        <td>${proxy.target || '<em>Routes dynamiques</em>'}</td>
                        <td><span class="status ${proxy.status}">${proxy.status}</span></td>
                        <td>${formatNumber(st.requests || st.total_connections || 0)}</td>
                        <td>${formatBytes(st.bytes_sent || 0)}</td>
                        <td>${formatBytes(st.bytes_received || 0)}</td>
                        <td>${formatUptime(proxy.uptime || 0)}</td>
                    </tr>`;
                });
            } else {
                html += '<tr><td colspan="9" style="text-align:center;color:#8b949e;">Aucun proxy configur√©</td></tr>';
            }
            
            html += '</tbody></table>';
            
            html += '<div class="info-box">';
            html += `<p>‚è∞ <strong>Derni√®re mise √† jour:</strong> ${new Date(stats.timestamp).toLocaleString('fr-FR')}</p>`;
            html += `<p>‚öôÔ∏è <strong>Mode maintenance:</strong> ${stats.maintenance_mode ? '‚ö†Ô∏è ACTIF' : '‚úÖ D√©sactiv√©'}</p>`;
            html += '</div>';
            
            document.getElementById('stats-container').innerHTML = html;
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function formatNumber(num) {
            return num.toLocaleString('fr-FR');
        }
        
        function formatUptime(seconds) {
            if (seconds < 60) return seconds + 's';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'min';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'j';
        }
        
        async function testAPI(endpoint, method, body = null) {
            try {
                const result = await apiCall(endpoint, method, body);
                document.getElementById('result').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('result').textContent = 'Erreur: ' + error.message;
            }
        }
        
        async function restartService() {
            if (confirm('‚ö†Ô∏è Red√©marrer le service ProxyOX ? Tous les proxies seront red√©marr√©s.')) {
                await testAPI('/api/restart', 'POST');
                alert('Le service red√©marre... Rechargez la page dans 5 secondes.');
            }
        }
        
        async function reloadConfig() {
            await testAPI('/api/reload-config', 'POST');
        }
        
        async function validateConfig() {
            await testAPI('/api/config/validate', 'GET');
        }
        
        async function toggleMaintenance() {
            const enable = confirm('Activer le mode maintenance ?');
            await testAPI('/api/maintenance', 'POST', { enabled: enable });
        }
        
        function exportJSON() {
            window.open('/api/export/json', '_blank');
        }
        
        function exportCSV() {
            window.open('/api/export/csv', '_blank');
        }
        
        async function getSystemInfo() {
            await testAPI('/api/system/info', 'GET');
        }
        
        function startProxy() {
            const name = prompt('Nom du proxy √† d√©marrer :');
            if (name) {
                testAPI(`/api/proxy/${name}/start`, 'POST');
            }
        }
        
        function stopProxy() {
            const name = prompt('Nom du proxy √† arr√™ter :');
            if (name) {
                testAPI(`/api/proxy/${name}/stop`, 'POST');
            }
        }
        
        // Charger les stats au d√©marrage et toutes les 3 secondes
        loadStats();
        setInterval(loadStats, 3000);
    </script>
</body>
</html>